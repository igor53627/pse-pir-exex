<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wallet Core Demo - PIR + Helios</title>
    <style>
        :root {
            --bg: #0f0f1a;
            --card: #1a1a2e;
            --accent: #7f5af0;
            --text: #e0e0e0;
            --success: #2ecc71;
            --error: #e74c3c;
            --warn: #f39c12;
        }
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
        }
        h1 { color: var(--accent); margin-bottom: 5px; }
        .subtitle { color: #888; margin-bottom: 30px; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
        }
        .card h3 { margin-top: 0; color: var(--accent); }
        label { display: block; margin: 10px 0 5px; font-size: 14px; }
        input, select {
            width: 100%;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #333;
            background: #0a0a12;
            color: var(--text);
            font-size: 14px;
            box-sizing: border-box;
        }
        button {
            padding: 12px 24px;
            border-radius: 6px;
            border: none;
            background: var(--accent);
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-top: 15px;
        }
        button:hover { background: #6b4ed8; }
        button:disabled { background: #444; cursor: not-allowed; }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        .status.success { background: var(--success); color: #000; }
        .status.error { background: var(--error); }
        .status.pending { background: var(--warn); color: #000; }
        .status.idle { background: #444; }
        #log {
            background: #0a0a0a;
            border-radius: 6px;
            padding: 15px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .log-info { color: #3498db; }
        .log-success { color: var(--success); }
        .log-error { color: var(--error); }
        .balance-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #333;
        }
        .balance-value { font-family: monospace; font-size: 18px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        @media (max-width: 600px) { .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <h1>Wallet Core Demo</h1>
    <p class="subtitle">Private balance queries via PIR with Helios light client verification</p>

    <div class="card">
        <h3>Configuration</h3>
        <div class="grid">
            <div>
                <label>PIR Server URL</label>
                <input type="text" id="pirServer" value="http://localhost:3000">
            </div>
            <div>
                <label>Network</label>
                <select id="network">
                    <option value="mainnet">Mainnet</option>
                    <option value="holesky">Holesky</option>
                    <option value="sepolia">Sepolia</option>
                </select>
            </div>
            <div>
                <label>Execution RPC</label>
                <input type="text" id="executionRpc" value="https://eth-mainnet.g.alchemy.com/v2/demo">
            </div>
            <div>
                <label>Consensus RPC</label>
                <input type="text" id="consensusRpc" value="https://ethereum.operationsolarstorm.org">
            </div>
        </div>
        <button id="initBtn" onclick="initialize()">Initialize</button>
        <span id="initStatus" class="status idle" style="margin-left: 10px;">Not initialized</span>
    </div>

    <div class="card">
        <h3>Snapshot Verification</h3>
        <p>Helios verifies that the PIR server's snapshot block hash matches the canonical chain.</p>
        <div id="snapshotInfo" style="font-family: monospace; margin: 10px 0;">
            Block: --<br>
            Hash: --<br>
        </div>
        <button id="verifyBtn" onclick="verifySnapshot()" disabled>Verify with Helios</button>
        <span id="verifyStatus" class="status idle" style="margin-left: 10px;">--</span>
    </div>

    <div class="card">
        <h3>Private Balance Query</h3>
        <label>Ethereum Address</label>
        <input type="text" id="queryAddress" placeholder="0x...">
        <button id="queryBtn" onclick="queryBalance()" disabled>Query Balance (PIR)</button>
        
        <div id="balanceResult" style="margin-top: 20px; display: none;">
            <div class="balance-row">
                <span>ETH Balance</span>
                <span class="balance-value" id="ethBalance">--</span>
            </div>
            <div class="balance-row">
                <span>USDC Balance</span>
                <span class="balance-value" id="usdcBalance">--</span>
            </div>
            <div style="margin-top: 10px; font-size: 12px; color: #888;">
                Snapshot block: <span id="resultBlock">--</span> |
                Verified: <span id="resultVerified">--</span>
            </div>
        </div>
    </div>

    <div class="card">
        <h3>Server View (What PIR Server Sees)</h3>
        <p style="font-size: 12px; color: #888; margin-bottom: 10px;">
            This shows what an honest-but-curious server observes. Note: the server cannot determine which address you queried.
        </p>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
            <div style="background: #1a0a0a; border: 1px solid #e74c3c; border-radius: 6px; padding: 12px;">
                <div style="color: #e74c3c; font-weight: 600; margin-bottom: 8px;">[X] Standard RPC</div>
                <div style="font-size: 11px; font-family: monospace; color: #888;">
                    eth_getBalance(0xd8dA6BF...)<br>
                    <span style="color: #e74c3c;">Server sees: exact address</span>
                </div>
            </div>
            <div style="background: #0a1a0a; border: 1px solid #2ecc71; border-radius: 6px; padding: 12px;">
                <div style="color: #2ecc71; font-weight: 600; margin-bottom: 8px;">[OK] PIR Query</div>
                <div style="font-size: 11px; font-family: monospace; color: #888;">
                    POST /query [RLWE ciphertext]<br>
                    <span style="color: #2ecc71;">Server sees: encrypted noise</span>
                </div>
            </div>
        </div>
        <div id="serverLog" style="background: #0a0a0a; border-radius: 6px; padding: 15px; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto;">
        </div>
    </div>

    <div class="card">
        <h3>Client Log</h3>
        <div id="log"></div>
    </div>

    <script type="module">
        import { createHeliosProvider } from 'https://unpkg.com/@a16z/helios@0.10.2/dist/lib.mjs';

        let heliosProvider = null;
        let pirClient = null;
        let metadata = null;
        let snapshotVerified = false;

        function log(msg, type = 'info') {
            const logDiv = document.getElementById('log');
            const ts = new Date().toISOString().split('T')[1].slice(0, 12);
            logDiv.innerHTML += `<span class="log-${type}">[${ts}] ${msg}</span>\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function serverLog(entry) {
            const div = document.getElementById('serverLog');
            const ts = new Date().toISOString().split('T')[1].slice(0, 12);
            div.innerHTML += `<div style="border-bottom: 1px solid #222; padding: 8px 0;">
                <div style="color: #f39c12;">[${ts}] ${entry.method} ${entry.endpoint}</div>
                <div style="color: #666; margin-top: 4px;">
                    Client IP: ${entry.clientIp}<br>
                    Request size: ${entry.requestSize}<br>
                    ${entry.queryData ? `<span style="color: #e74c3c;">Query payload: ${entry.queryData}</span>` : ''}
                    ${entry.note ? `<br><span style="color: #2ecc71;">${entry.note}</span>` : ''}
                </div>
            </div>`;
            div.scrollTop = div.scrollHeight;
        }

        function setStatus(id, status, text) {
            const el = document.getElementById(id);
            el.className = `status ${status}`;
            el.textContent = text;
        }

        window.initialize = async function() {
            const pirServer = document.getElementById('pirServer').value;
            const network = document.getElementById('network').value;
            const executionRpc = document.getElementById('executionRpc').value;
            const consensusRpc = document.getElementById('consensusRpc').value;

            setStatus('initStatus', 'pending', 'Initializing...');
            document.getElementById('initBtn').disabled = true;

            try {
                log('Fetching PIR server metadata...', 'info');
                const metaRes = await fetch(`${pirServer}/metadata/balances`);
                if (metaRes.ok) {
                    metadata = await metaRes.json();
                    log(`Metadata loaded: ${metadata.numRecords} addresses at block ${metadata.snapshotBlock}`, 'success');
                    
                    serverLog({
                        method: 'GET',
                        endpoint: '/metadata/balances',
                        clientIp: '192.168.1.x',
                        requestSize: '0 bytes',
                        note: 'Public metadata - no privacy leak'
                    });
                    
                    document.getElementById('snapshotInfo').innerHTML = `
                        Block: ${metadata.snapshotBlock}<br>
                        Hash: ${metadata.snapshotBlockHash}<br>
                        Addresses: ${metadata.numRecords}
                    `;
                } else {
                    log('PIR server not available (demo mode)', 'info');
                    serverLog({
                        method: 'GET',
                        endpoint: '/crs/balances',
                        clientIp: '192.168.1.x',
                        requestSize: '0 bytes',
                        note: 'CRS (public parameters) - no privacy leak'
                    });
                }

                log('Initializing Helios light client...', 'info');
                log(`Network: ${network}, Consensus: ${consensusRpc}`, 'info');
                
                heliosProvider = await createHeliosProvider({
                    executionRpc,
                    consensusRpc,
                    network,
                }, network === 'mainnet' ? 'ethereum' : network);

                log('Waiting for Helios to sync...', 'info');
                await heliosProvider.waitSynced();
                
                const blockNum = await heliosProvider.request({ method: 'eth_blockNumber', params: [] });
                log(`Helios synced! Current block: ${parseInt(blockNum, 16)}`, 'success');

                setStatus('initStatus', 'success', 'Ready');
                document.getElementById('verifyBtn').disabled = false;
                document.getElementById('queryBtn').disabled = false;

            } catch (e) {
                log(`Error: ${e.message}`, 'error');
                setStatus('initStatus', 'error', 'Failed');
                console.error(e);
            }

            document.getElementById('initBtn').disabled = false;
        };

        window.verifySnapshot = async function() {
            if (!heliosProvider || !metadata) {
                log('Initialize first', 'error');
                return;
            }

            setStatus('verifyStatus', 'pending', 'Verifying...');

            try {
                const blockHex = `0x${metadata.snapshotBlock.toString(16)}`;
                log(`Fetching block ${metadata.snapshotBlock} from Helios...`, 'info');
                
                const block = await heliosProvider.request({
                    method: 'eth_getBlockByNumber',
                    params: [blockHex, false]
                });

                if (!block) {
                    throw new Error('Block not found');
                }

                const expected = metadata.snapshotBlockHash.toLowerCase();
                const actual = block.hash.toLowerCase();

                if (expected === actual) {
                    log(`[OK] Block hash verified: ${actual.slice(0, 18)}...`, 'success');
                    setStatus('verifyStatus', 'success', 'Verified');
                    snapshotVerified = true;
                } else {
                    log(`[FAIL] Hash mismatch! Expected: ${expected}, Got: ${actual}`, 'error');
                    setStatus('verifyStatus', 'error', 'Mismatch');
                    snapshotVerified = false;
                }

            } catch (e) {
                log(`Verification error: ${e.message}`, 'error');
                setStatus('verifyStatus', 'error', 'Error');
                console.error(e);
            }
        };

        window.queryBalance = async function() {
            const address = document.getElementById('queryAddress').value;
            if (!address) {
                log('Enter an address', 'error');
                return;
            }

            log(`Querying balance for ${address.slice(0, 10)}...`, 'info');

            if (!metadata) {
                log('Demo mode: Showing mock balance', 'info');
                document.getElementById('balanceResult').style.display = 'block';
                document.getElementById('ethBalance').textContent = '1.2345 ETH';
                document.getElementById('usdcBalance').textContent = '100.00 USDC';
                document.getElementById('resultBlock').textContent = 'N/A (demo)';
                document.getElementById('resultVerified').textContent = 'N/A';
                return;
            }

            const idx = metadata.addresses.findIndex(
                a => a.toLowerCase() === address.toLowerCase()
            );

            if (idx < 0) {
                log('Address not in hot lane', 'info');
                document.getElementById('balanceResult').style.display = 'block';
                document.getElementById('ethBalance').textContent = 'Not in hot lane';
                document.getElementById('usdcBalance').textContent = '--';
                return;
            }

            log(`Address found at index ${idx}, sending PIR query...`, 'info');
            
            const mockQuerySize = (230 * 1024).toLocaleString();
            serverLog({
                method: 'POST',
                endpoint: '/query/balances/seeded/binary',
                clientIp: '192.168.1.x',
                requestSize: `~${mockQuerySize} bytes`,
                queryData: '[RLWE ciphertext - 2048 polynomials, seed-expanded]',
                note: 'Server cannot determine queried index from ciphertext!'
            });
            
            log('[PIR query would happen here - requires running server]', 'info');
            
            document.getElementById('balanceResult').style.display = 'block';
            document.getElementById('ethBalance').textContent = '-- ETH (PIR server required)';
            document.getElementById('usdcBalance').textContent = '-- USDC';
            document.getElementById('resultBlock').textContent = metadata.snapshotBlock;
            document.getElementById('resultVerified').textContent = snapshotVerified ? 'Yes' : 'No';
        };

        log('Page loaded. Enter config and click Initialize.', 'info');
    </script>
</body>
</html>
